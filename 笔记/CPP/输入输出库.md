---
title: 输入输出库
categories: CPP
tags:
 - CPP
---

# 输入输出库

输入输出库是最先接触的东西，但也是抽象较多的东西、结果较为复杂的对象。其目标是为了实现如下两个关键功能：

1. 提供格式化输出能力，即将int、double、C style string、string等一系列类型，能够正确序列化到一串缓冲区中。
2. 管理库内部缓冲区，当缓冲区内部数据不足或者空间不足时做出相应的处理。

> 接触了Unix系统调用的write、read函数之后，明显意识到的一件事就是对系统来说根本不存在字符流的概念。举例来说，cin过程中我们需要注意所谓的什么回车、空格这类字符，其实是I/O库实现和标记的，他们只是为了方便我们实现str -> 基本数据类型转换的目的（毕竟要对数据进行区分）。cout过程中，int也不是本身就能被打印到屏幕的，他是经过int 转化为string，然后才能进行下一步处理。

以cin，cout的工作流程举例来说其经历了一下几个流程。

`cout << 1024` 打印一个整数需要经历的过程如下

1. 需要将1024转换为一个字符串（这里生成的字符串并不是null-terminal，而是4字符的）
2. 将1024字符串的内容（4字节）复制到缓冲区当中
3. 缓冲区位于用户空间，其能有效减少用户空间向内核空间复制数据的次数（系统调用相对耗时）。I/O根据其策略判断是否flush缓冲（行缓冲、全缓冲、不缓冲）。
4. 缓冲区的数据一但flush，其便会将那段buff提交给内核。写过write调用的自然知道`write(fd, buff_addr, len)`这个函数，其需要buff的地址buff_addr和buff中存储的数据长度len。

`cin >> num`输入一个整数会经历如下过程：

1. 如果I/O缓冲区内部存在数据直接进行第2步，否则从内核缓冲区读取数据至进程I/O缓冲区
2. 从I/O缓冲区中处理数据（字符串），提取内部的整数字串（利用空格、换行），并将其转化为整数（string->int）

3. 如果输入流的数据无法被转化为int，则将流状态设置为异常。

> 这种利用控制字符来分离字符串中的各个数据，是处理字符串并将自动其转化为相应数据类型的方法，但并不是唯一方式，我们学习过的xml，json都是一种将str -> 内部类型的方式（序列化、反序列化）。为什么需要进行这种转化，个人觉得有一下原因：1、二进制文件在不同系统使用时存在问题，例如int、double大小不一致、字节序不一致等，这种数据用于传输时没有什么价值，不过本机使用倒是无碍，或者世界大一统底层完全一致:）。字符文件格式提供了一种统一的二进制存储方式，更有利于不同计算机系统查看。2、对于标准输入，配置文件来说，其需要人可以查看、可以编辑的要求，二进制的话编辑起来很反人类。

**缓冲区作用**

缓冲区常见于两个异步设备之间，其目的是为了减低同步损耗。磁盘I/O缓冲区属于经典的生产者消费者模型，以应用程序向磁盘写入数据为例，假如进程A调用了10次write，其会向内核缓冲区写入10次数据。之后内核可能依据其调度策略将缓冲区内部的内容写入到磁盘当中。如果这10次写的数据量不是很大且数据连续，很可能到最后就只是一次磁盘写调用。如果不添加缓冲区，那么我们每次写都会直接将数据写入到磁盘，这样会导致多次磁盘写调用很浪费。不过这也与存储设备特性有关，毕竟磁盘是一个块设备，其基本读写单元是扇区，如果换成存储设备为内存，就不需要缓冲区了。

